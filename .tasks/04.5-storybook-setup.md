# Task 04.5: Storybook Integration

**Status**: ‚úÖ COMPLETE
**Dependencies**: Task 04 (State Management)
**Effort**: 2-3 hours
**Phase**: Foundation (Phase 1)

## Objective

Integrate Storybook into the SQUI project to enable component-driven development, visual testing, accessibility checks, and auto-generated documentation. This provides a development environment for building and testing components in isolation.

## What Was Implemented

### 1. Storybook Installation

Installed Storybook v9.1.15 with SvelteKit support and essential addons:

- **Core**: `@storybook/sveltekit@^9.1.15`
- **Addons**:
  - `@storybook/addon-docs` - Auto-generated documentation
  - `@storybook/addon-a11y` - Accessibility testing (WCAG compliance)
  - `@storybook/addon-vitest` - Integration with Vitest
  - `@storybook/addon-svelte-csf` - Svelte CSF story format
  - `@chromatic-com/storybook` - Visual regression testing support

### 2. Configuration Files

#### `.storybook/main.ts`
- Configured story patterns to find all `*.stories.svelte` files
- Enabled TypeScript checking
- Configured essential addons

#### `.storybook/preview.ts`
- Imported Carbon Design System CSS globally
- Configured accessibility addon with Carbon-specific rules
- Set up background options for all 4 Carbon themes (white, g10, g90, g100)
- Added theme decorator for automatic theme switching
- Configured controls, actions, and docs parameters

### 3. Component Stories Created

Created comprehensive stories for existing components:

#### **SplitPane Component** ([src/lib/components/Layout/SplitPane.stories.svelte](src/lib/components/Layout/SplitPane.stories.svelte:1))
- Default (50/50 split)
- Top-heavy (70/30)
- Bottom-heavy (30/70)
- With constraints (minimum heights)
- Accessibility demo
- Dark theme example

#### **Toolbar Component** ([src/lib/components/Toolbar/Toolbar.stories.svelte](src/lib/components/Toolbar/Toolbar.stories.svelte:1))
- Default empty toolbar
- With basic controls
- Full controls
- With form controls
- Compact variant
- All 4 Carbon themes (white, g10, g90, g100)
- Accessibility demo
- Responsive example

#### **SparqlQueryUI Component** ([src/SparqlQueryUI.stories.svelte](src/SparqlQueryUI.stories.svelte:1))
- Default configuration
- DBpedia endpoint
- Wikidata endpoint
- All 4 Carbon themes
- Custom limits
- All features enabled/disabled
- Fixed endpoint
- Embedded (800x600)
- Full configuration example

### 4. NPM Scripts

Added to `package.json`:
```json
{
  "scripts": {
    "storybook": "storybook dev -p 6006",
    "build-storybook": "storybook build"
  }
}
```

## Usage

### Running Storybook

Start the development server:
```bash
npm run storybook
```

Storybook will be available at: http://localhost:6006

### Building Static Storybook

Build for deployment:
```bash
npm run build-storybook
```

Output: `storybook-static/` directory

### Writing New Stories

When creating a new component, add a `.stories.svelte` file alongside it:

```typescript
// MyComponent.stories.svelte
<script context="module" lang="ts">
  import type { Meta } from '@storybook/svelte';
  import MyComponent from './MyComponent.svelte';

  export const meta: Meta<typeof MyComponent> = {
    title: 'Category/MyComponent',
    component: MyComponent,
    tags: ['autodocs'],
    argTypes: {
      // Define controls for props
      myProp: {
        control: 'text',
        description: 'Description of the prop',
      },
    },
    parameters: {
      docs: {
        description: {
          component: 'Component description for docs',
        },
      },
    },
  };
</script>

<script lang="ts">
  import { Story } from '@storybook/addon-svelte-csf';
</script>

<!-- Default story -->
<Story name="Default">
  <MyComponent myProp="value" />
</Story>

<!-- Additional variants -->
<Story name="Variant" args={{ myProp: 'different value' }}>
  <MyComponent myProp="different value" />
</Story>
```

## Benefits for SQUI Development

### 1. Component Isolation
- Develop components independently of the full app
- Test different states without complex setup
- Faster iteration during development

### 2. Visual Testing
- See all component variants at a glance
- Test across all 4 Carbon themes instantly
- Catch visual regressions early

### 3. Accessibility Testing
- Built-in a11y addon catches WCAG issues
- Test keyboard navigation
- Verify ARIA attributes
- Ensures WCAG AA compliance (Task 42-44)

### 4. Documentation
- Auto-generated docs from stories
- Live component playground
- Serves as component library documentation for NPM package (Task 48-50)

### 5. Integration with Existing Tests
- Stories can be reused in Vitest tests
- Complements unit, integration, and E2E tests
- Provides visual regression testing capability

## Integration with Task Workflow

### For Future Tasks

When implementing new components in upcoming tasks:

1. **Write component** (`.svelte` file)
2. **Write tests** (unit/integration tests)
3. **Write story** (`.stories.svelte` file)
4. **Verify in Storybook** (visual check, a11y check)
5. **Commit** (component + tests + story together)

### Recommended Story Coverage

| Task Phase | Story Priority | Examples |
|------------|----------------|----------|
| **Phase 2: SPARQL Editor** (06-12) | **High** | Editor states, autocompletion UI, syntax highlighting |
| **Phase 3: Endpoint Management** (13-15) | Medium | Endpoint input, validation states, catalogue |
| **Phase 4: SPARQL Protocol** (16-18) | Medium | Loading states, error displays |
| **Phase 5-6: Results** (19-31) | **Very High** | Table views, sorting, filtering, different result types |
| **Phase 8: Raw & Downloads** (35-38) | High | Format switching, download buttons |
| **Phase 9: Multiple Tabs** (39-41) | High | Tab states, switching behavior |
| **Phase 10: Accessibility** (42-44) | **Very High** | Use a11y addon to verify WCAG compliance |

## Files Created/Modified

### Created
- `.storybook/main.ts` - Storybook main configuration
- `.storybook/preview.ts` - Preview configuration with Carbon theme support
- `src/lib/components/Layout/SplitPane.stories.svelte` - SplitPane stories
- `src/lib/components/Toolbar/Toolbar.stories.svelte` - Toolbar stories
- `src/SparqlQueryUI.stories.svelte` - Main component stories
- `.tasks/04.5-storybook-setup.md` - This documentation

### Modified
- `package.json` - Added Storybook dependencies and scripts

### Deleted
- `src/stories/` - Removed example stories from Storybook init

## Storybook Addons Reference

### @storybook/addon-docs
Auto-generates documentation from component metadata and stories.

**Features**:
- Props table from TypeScript types
- Story source code display
- Description from JSDoc comments

### @storybook/addon-a11y
Tests components for accessibility issues.

**Features**:
- WCAG compliance checking
- Color contrast verification
- ARIA attribute validation
- Keyboard navigation testing

**Usage**: Check the "Accessibility" tab in Storybook UI for each story.

### @storybook/addon-vitest
Integrates stories with Vitest for testing.

**Features**:
- Reuse stories in unit tests
- Consistent test data
- Visual + functional testing

## Theme Switching

Storybook is configured with Carbon Design System themes:

### Using the Toolbar
1. Open any story
2. Click the **paintbrush icon** in the toolbar
3. Select theme: White üåû, G10 ‚òÄÔ∏è, G90 üåô, or G100 üåë

### Using Backgrounds Addon
1. Click **backgrounds** in the toolbar
2. Select background color matching the theme
3. Components automatically adapt using CSS variables

### In Story Code
```svelte
<Story
  name="DarkTheme"
  parameters={{ backgrounds: { default: 'g90' } }}
>
  <div class="g90">
    <MyComponent />
  </div>
</Story>
```

## Best Practices

### 1. Story Organization
- Place `.stories.svelte` files next to components
- Use clear, descriptive story names
- Group related variants together

### 2. Story Naming
- Use `PascalCase` for story names
- Be descriptive: `WithLongText`, `ErrorState`, `DarkTheme`
- Avoid generic names: `Example1`, `Test2`

### 3. Args and Controls
- Define `argTypes` for all props
- Provide meaningful descriptions
- Set appropriate control types (text, number, boolean, select, etc.)

### 4. Accessibility
- Check every story with the a11y addon
- Fix violations before committing
- Add specific accessibility demo stories for complex interactions

### 5. Documentation
- Use `tags: ['autodocs']` for auto-generated docs
- Write component descriptions in `meta.parameters.docs`
- Add JSDoc comments to components for better docs

## Testing Integration

### Using Stories in Vitest Tests

Stories can be imported and tested:

```typescript
// MyComponent.test.ts
import { render } from '@testing-library/svelte';
import MyComponent from './MyComponent.svelte';

test('default story renders correctly', () => {
  const { container } = render(MyComponent, {
    props: {
      // Use same props as Default story
      myProp: 'value',
    },
  });

  expect(container).toMatchSnapshot();
});
```

## License Compatibility

All Storybook packages use **MIT License**, which is fully compatible with the project's **Apache License 2.0**.

## Next Steps

1. **Continue with Task 05**: Localization setup
2. **Add stories incrementally**: For each new component created in future tasks
3. **Use a11y addon regularly**: Especially for Phase 10 (Accessibility tasks)
4. **Deploy Storybook**: Consider deploying static build for team collaboration

## Success Criteria

- ‚úÖ Storybook runs successfully (`npm run storybook`)
- ‚úÖ All 3 component stories display correctly
- ‚úÖ Theme switching works across all 4 Carbon themes
- ‚úÖ A11y addon shows no critical violations
- ‚úÖ Auto-generated docs display component props
- ‚úÖ Stories use Svelte 5 patterns ($props, etc.)
- ‚úÖ TypeScript types are properly integrated

## Resources

- [Storybook Svelte Documentation](https://storybook.js.org/docs/svelte/get-started/introduction)
- [Carbon Design System](https://carbondesignsystem.com/)
- [Accessibility Addon](https://storybook.js.org/addons/@storybook/addon-a11y)
- [Writing Stories](https://storybook.js.org/docs/svelte/writing-stories/introduction)

---

**Task completed**: 2025-10-26
**Storybook version**: 9.1.15
**Integration**: Seamless with Svelte 5, Carbon Design System, and TypeScript
